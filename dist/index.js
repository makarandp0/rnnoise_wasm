(()=>{"use strict";var e=function(e,t,n,o){return new(n||(n=Promise))((function(i,a){function d(e){try{s(o.next(e))}catch(e){a(e)}}function c(e){try{s(o.throw(e))}catch(e){a(e)}}function s(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(d,c)}s((o=o.apply(e,t||[])).next())}))};class t extends AudioWorkletNode{constructor(e){super(e,"rnnoise",{channelCountMode:"explicit",channelCount:1,channelInterpretation:"speakers",numberOfInputs:1,numberOfOutputs:1,outputChannelCount:[1],processorOptions:{module:t.webModule}}),this._vadProb=0,this._isActive=!0,console.log("RNNoiseNode constructor"),this.port.onmessage=({data:e})=>{e.vadProb&&(this._vadProb=e.vadProb,this._isActive=e.isActive,this._onUpdate&&this._onUpdate())}}static register(n){return e(this,void 0,void 0,(function*(){t.webModule=yield function(t){return e(this,void 0,void 0,(function*(){const e=yield fetch("rnnoise-processor.wasm"),t=yield e.arrayBuffer();return yield WebAssembly.compile(t)}))}(),yield n.audioWorklet.addModule("processor.js")}))}onUpdate(e){this._onUpdate=e}getVadProb(){return this._vadProb}getIsActive(){return this._isActive}update(e){this.port.postMessage(e)}}t.webModule=null;var n=function(e,t,n,o){return new(n||(n=Promise))((function(i,a){function d(e){try{s(o.next(e))}catch(e){a(e)}}function c(e){try{s(o.throw(e))}catch(e){a(e)}}function s(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(d,c)}s((o=o.apply(e,t||[])).next())}))};const o=document.getElementById("input"),i=document.getElementById("output"),a=document.getElementById("vadProb"),d=document.getElementById("start"),c=document.getElementById("use_rnn"),s=Audio.prototype.setSinkId;!function(){n(this,void 0,void 0,(function*(){yield function(){return n(this,void 0,void 0,(function*(){(yield navigator.mediaDevices.getUserMedia({audio:!0})).getTracks().forEach((e=>{e.stop()}));let e=yield navigator.mediaDevices.enumerateDevices();o.disabled=!1,s&&(i.disabled=!1),e.forEach((e=>{"audioinput"==e.kind?o.appendChild(Object.assign(document.createElement("option"),{value:e.deviceId,textContent:e.label})):"audiooutput"==e.kind&&i.appendChild(Object.assign(document.createElement("option"),{value:e.deviceId,textContent:e.label}))}))}))}(),console.log("done setting up devices"),d.disabled=!1,d.addEventListener("click",(()=>{console.log("calling onStart"),function(){n(this,void 0,void 0,(function*(){console.log("onStart"),d.disabled=i.disabled=o.disabled=!0;const e=yield navigator.mediaDevices.getUserMedia({audio:{deviceId:{exact:o.value},channelCount:{ideal:1},noiseSuppression:{ideal:!1},echoCancellation:{ideal:!0},autoGainControl:{ideal:!1},sampleRate:{ideal:48e3}}}),r=new AudioContext({sampleRate:48e3});try{let o=r.destination;if(s){o=new MediaStreamAudioDestinationNode(r,{channelCountMode:"explicit",channelCount:1,channelInterpretation:"speakers"});const e=new Audio;e.srcObject=o.stream,e.setSinkId(i.value),e.play()}const{track:d,rnnoise:u}=yield function(e,o){return n(this,void 0,void 0,(function*(){o=o||new AudioContext({sampleRate:48e3}),yield t.register(o);const n=new MediaStream([e]),i=o.createMediaStreamSource(n),a=new t(o),d=o.createMediaStreamDestination();i.connect(a),a.connect(d);const c=d.stream;return{audio_context:o,track:c.getTracks()[0],rnnoise:a}}))}(e.getTracks()[0],r);u.connect(o),u.onUpdate((()=>{u.getVadProb();const e=100*u.getVadProb();a.style.width=e+"%"}));let l=null;const p=e=>{e?l=requestAnimationFrame((()=>{u.update(!0),p(!0)})):(u.update(!1),cancelAnimationFrame(l))};c.checked=!0,c.disabled=!1,p(!0),c.addEventListener("change",(e=>{try{p(c.checked)}catch(e){console.log("Error:",e)}}))}catch(e){r.close(),console.error(e)}}))}(),d.disabled=!1}))}))}()})();